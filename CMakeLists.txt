cmake_minimum_required(VERSION 3.15)
project(assembler)

set(CMAKE_CXX_STANDARD 17)
add_subdirectory(abseil-cpp)
add_subdirectory(mimalloc)
include_directories(abseil-cpp mimalloc)
add_executable(assembler main.cpp global.h)
set(ABSL_LIBS absl::flat_hash_map)
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g")
add_library(meta STATIC instructions_types.h instructions_types.cpp)
add_library(parsing STATIC j.h i.h i.cpp r.h r.cpp ri.cpp ri.h cop.cpp cop.h parser.h parser.cpp)
target_link_libraries(parsing meta ${ABSL_LIBS})
target_link_libraries(assembler PUBLIC mimalloc-static)

enable_testing()
function(unit_test name)
    add_executable(test_${name} tests/test_${name}.cpp)
    add_test(test_${name}_run test_${name})
    target_link_libraries(test_${name} parsing)
    target_compile_definitions(test_${name} PRIVATE TEST)
endfunction()

unit_test(parser)
unit_test(r)
unit_test(ri)
unit_test(cop)
unit_test(i)
unit_test(j)